pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Print Working Directory on Jenkins') {
            steps {
                script {
                    sh 'pwd'
                }
            }
        }

        stage('Validate Docker Compose File') {
            steps {
                script {
                    sh '''
                    if [ -f docker-compose.yml ]; then
                        echo "docker-compose.yml exists"
                        cat docker-compose.yml
                    else
                        echo "docker-compose.yml does not exist"
                        exit 1
                    fi
                    '''
                }
            }
        }

        stage('Run Docker Compose on Remote Server') {
            steps {
                sshagent(['remote-server-ssh-credentials-id']) {
                    script {
                        // Check Docker Compose version
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Checking Docker Compose version..."
                        docker compose version || docker-compose --version
                        '
                        '''
                        // Pull images
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Pulling Docker images..."
                        cd /path/to/docker-compose/directory &&
                        docker compose pull || docker-compose pull
                        '
                        '''
                        // Run Docker Compose
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Starting Docker Compose..."
                        cd /path/to/docker-compose/directory &&
                        docker compose up -d || docker-compose up -d
                        '
                        '''
                        // Verify Docker Compose services
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Listing Docker Compose services..."
                        cd /path/to/docker-compose/directory &&
                        docker compose ps || docker-compose ps
                        '
                        '''
                    }
                }
            }
        }

        stage('Tear Down') {
            steps {
                sshagent(['remote-server-ssh-credentials-id']) {
                    script {
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Tearing down Docker Compose stack..."
                        cd /path/to/docker-compose/directory &&
                        docker compose down || docker-compose down
                        '
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            sshagent(['remote-server-ssh-credentials-id']) {
                script {
                    sh '''
                    ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                    echo "Tearing down Docker Compose stack..."
                    cd /path/to/docker-compose/directory &&
                    docker compose down || docker-compose down
                    '
                    '''
                }
            }
        }
    }
}
