pipeline {
    agent { label 'agent1' } // Specify the node labeled 'agent1'

    stages {
        stage('Run Docker Compose on Remote Server') {
            steps {
                sshagent(['jenkins-SM-login']) {
                    script {
                        // Connect to the remote server and run Docker Compose commands
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Checking Docker Compose version..."
                        docker compose version || docker-compose --version
                        '
                        '''
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Pulling Docker images..."
                        pwd
                        '
                        '''
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Starting Docker Compose..."
                        docker stack deploy --compose-file docker-compose.yml my-swarm-stack
                        '
                        '''
                        sh '''
                        ssh -o StrictHostKeyChecking=no root@192.168.6.152 '
                        echo "Listing Docker Compose services..."
                        cd /path/to/docker-compose/directory &&
                        docker compose ps || docker-compose ps
                        '
                        '''
                    }
                }
            }
        }
    }
}
